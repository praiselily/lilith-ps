# Borrowed base scipt from nolww and added sig checks
Start-Sleep -Seconds 1
Write-Host "Optimized by Lily (the BEST sser****)" -ForegroundColor Red
Write-Host "Analyzing scheduled tasks..." -ForegroundColor Red
Start-Sleep -Seconds 1

function Test-Signature {
    param([string]$Path)
    try {
        return (Get-AuthenticodeSignature -FilePath $Path -ErrorAction Stop).Status -eq "Valid"
    }
    catch { return $false }
}

function Get-FullPath {
    param([string]$ExePath)
    if ([string]::IsNullOrWhiteSpace($ExePath)) { return $null }
    $ExePath = $ExePath.Trim('"')
    $paths = @($ExePath, [Environment]::ExpandEnvironmentVariables($ExePath))
    if ($ExePath -notmatch '\\') {
        $paths += "$env:WINDIR\$ExePath", "$env:WINDIR\System32\$ExePath"
    }
    foreach ($path in $paths) {
        try { if (Test-Path -LiteralPath $path) { return $path } }
        catch { continue }
    }
    return $null
}

$suspectPrograms = "cmd.exe", "powershell.exe", "powershell_ise.exe", "rundll32.exe", "regsvr32.exe", "taskmgr.exe", "LaunchTM.exe", "WinRAR.exe"

$tasks = Get-ScheduledTask | ForEach-Object {
    $task = $_
    if ($task.Actions) {
        $task.Actions | ForEach-Object {
            $exeName = if ($_.Execute) { [System.IO.Path]::GetFileName($_.Execute.Trim('"')) } else { "" }
            $exePath = Get-FullPath $_.Execute
            [PSCustomObject]@{
                TaskName = $task.TaskName
                TaskPath = $task.TaskPath  
                Action = $_.Execute
                Arguments = $_.Arguments
                Suspicion = if ($suspectPrograms -contains $exeName) { "Yes" } else { "No" }
                Signed = if ($exePath) { if (Test-Signature $exePath) { "Yes" } else { "No" } } else { "Invalid Path" }
            }
        }
    }
}

if ($tasks) {
    $tasks | Out-GridView -Title "Scheduler Parser - Check signed column" -PassThru
} else {
    Write-Host "No tasks found"
}

Write-Host "PRESS ENTER TO QUIT" -ForegroundColor White
Read-Host
